# 实验作业二：Web攻防与安全测试实验报告（综合：作业一 + 作业二）

> 本报告按课程要求包含：封面、产品描述（作业一）、实验详情（作业二）、结尾（分工与源码链接）。

## 目录

- 一、封面
- 二、产品描述（作业一）
  - 2.1 产品简介与需求对照
  - 2.2 技术选型与目录结构
  - 2.3 会话管理与安全机制
  - 2.4 核心业务：图片水印管理（使用说明）
  - 2.5 部署与运行（HTTP/HTTPS）
  - 2.6 接口设计（页面 + API）
- 三、实验详情（作业二）
  - 3.1 攻防实验选择说明
  - 3.2 SQL 注入（漏洞版/防御版）
  - 3.3 命令注入（漏洞版/防御版）
  - 3.4 Web 安全测试（抓包对比、扫描与 fuzz）
- 四、结尾（分工与源码链接）
  - 4.1 小组分工与贡献
  - 4.2 源码链接

---

## 一、封面

- 报告名称：Web安全实验（作业一 & 作业二）综合报告
- 课程/班级：__________
- 指导老师：__________
- 小组成员：__________（姓名/学号/分工见“结尾”）
- 完成日期：__________

> TODO(截图-00)：封面（Word/PDF 封面页整体截图或导出）

---

## 二、产品描述（对应实验作业一）

### 2.1 产品简介与需求对照

产品名称：WebSec Lab（多用户图片水印管理平台）

产品定位：用于 Web 安全课程实验的本地可部署平台，包含用户管理 + 会话管理 + 操作审计 + 核心业务（图片水印），并在同一平台上提供 SQL 注入与命令注入的“漏洞版/防御版”对比实验入口。

需求对照（作业一）：

- 本地可部署运行：支持在 `localhost` 运行（HTTP/HTTPS 均可）
- 页面：主页、注册、登录、个人资料、操作记录、图片管理、攻防实验等
- 用户管理：注册、登录/登出、资料维护、账号删除；管理员可查看/删除用户
- 会话管理：Cookie Session（登录态/超时）
- 操作记录：对关键操作写入审计日志（含 IP/UA/时间）
- 核心业务：图片水印管理可完整运行与操作（上传/生成/预览/下载/删除；支持搜索、分页、批量操作）

> TODO(截图-01)：平台主页（未登录状态）

### 2.2 技术选型与目录结构

技术选型：

- 后端：Python 3.x + Flask（按模块划分：`auth/images/labs`）
- 前端：Bootstrap 5（本地静态资源）+ 少量原生 JS（用于全选/计数等交互）
- 数据库：SQLite（`var/app.db`）
- 图片处理：Pillow（生成文字水印图）
- Web 服务：
  - HTTP：Waitress（WSGI Server）
  - HTTPS：自签名证书（仅实验用途）+ HTTPS 监听端口

目录结构（节选）：

- `websec_app/`：Flask 应用
  - `auth.py`：注册/登录/会话/用户管理/审计日志
  - `images.py`：图片水印业务（上传/预览/下载/删除/批量/分页/搜索）
  - `labs.py`：SQL 注入 & 命令注入（漏洞版/防御版）
  - `templates/`：页面模板
  - `static/`：本地静态资源（Bootstrap、样式）
- `var/`：运行数据（SQLite DB、上传文件、水印文件、证书）
- `tools/`：启动脚本与 fuzz 工具

> TODO(截图-02)：项目目录结构（IDE 侧边栏或 `tree` 输出）

### 2.3 会话管理与安全机制

会话管理：

- 登录成功后写入 `session["user_id"]`，使用 Flask Cookie Session 维持登录态
- 支持会话超时（可通过 `SESSION_MINUTES` 配置）

基础安全机制（为实验平台提供“可控的安全基线”）：

- CSRF 防护：所有 `POST/PUT/PATCH/DELETE` 请求要求携带 `csrf_token`
- 密码存储：使用哈希存储（Werkzeug `generate_password_hash/check_password_hash`）
- 上传限制：仅允许图片后缀（`.png/.jpg/.jpeg/.bmp/.webp`），文件名进行安全处理
- 审计日志：记录登录/登出/资料修改/图片上传/删除/实验访问等

> TODO(截图-03)：浏览器 Cookie（登录后展示 Session Cookie）
> TODO(截图-04)：操作记录页（审计日志包含 IP/UA/时间）

### 2.4 核心业务：图片水印管理（使用说明）

入口：`/images`（登录后访问）

功能点（更像“管理页”的交互）：

- 列表管理：表格形式展示预览、文件名、水印、时间
- 搜索：按“文件名/水印文字”模糊检索
- 分页：支持 `per_page/page` 控制每页数量与翻页
- 批量删除：勾选多条记录后一次删除（同时清理磁盘文件）
- 批量重新生成水印：
  - 可选填写“覆盖水印文字”（留空则沿用该图片原水印文字）
  - 重新生成新的水印文件并更新记录

使用流程（建议写入你的实验截图）：

1) 注册并登录

> TODO(截图-05)：注册页面填写示例
> TODO(截图-06)：登录成功后的提示/导航栏用户信息

2) 上传图片生成水印

- 打开 `/images`，选择图片文件，填写水印文字，点击“上传”

> TODO(截图-07)：上传表单（选择图片 + 填写水印）
> TODO(截图-08)：上传成功后列表出现新记录（含预览图）

3) 详情页查看（水印图/原图）与下载

- 点击“详情”，在详情页切换“水印图/原图”，并下载水印图

> TODO(截图-09)：图片详情页（展示水印图）
> TODO(截图-10)：图片详情页（切换到原图 Tab）
> TODO(截图-11)：下载水印图（浏览器下载记录或下载弹窗）

4) 搜索与分页

- 在搜索框输入关键字（文件名或水印内容），观察筛选结果
- 调整“每页条数”，并进行翻页

> TODO(截图-12)：搜索条件与搜索结果
> TODO(截图-13)：分页条（显示第几页/总页数）

5) 批量操作

- 勾选多条记录
- 执行“批量删除”或“批量重新生成水印”

> TODO(截图-14)：批量勾选（全选/部分选中时的状态）与已选数量
> TODO(截图-15)：批量重新生成水印（填写覆盖水印文字并提交后结果）

### 2.5 部署与运行（HTTP/HTTPS）

方式 A（无需 mise）：

- `python tools/bootstrap.py setup`
- `python tools/bootstrap.py run-http`
- `python tools/bootstrap.py run-https`

方式 B（使用 mise，可选）：

- `mise trust`
- `mise run setup`
- `mise run run-http`
- `mise run run-https`

默认访问地址：

- HTTP：`http://127.0.0.1:5000`
- HTTPS：`https://127.0.0.1:5443`

> TODO(截图-16)：终端启动服务输出（包含监听地址/端口）
> TODO(截图-17)：浏览器访问 HTTPS 时的证书提示（自签名证书）

### 2.6 接口设计（页面 + API）

页面接口（节选）：

| 功能 | 方法 | URI | 入参 | 出参 |
|---|---|---|---|---|
| 主页 | GET | `/` | 无 | HTML |
| 注册 | GET/POST | `/register` | `username,password,csrf_token` | 重定向/HTML |
| 登录 | GET/POST | `/login` | `username,password,next,csrf_token` | 重定向/HTML |
| 登出 | POST | `/logout` | `csrf_token` | 重定向 |
| 个人资料 | GET/POST | `/profile` | `display_name,description,csrf_token` | 重定向/HTML |
| 删除账号 | POST | `/account/delete` | `confirm,csrf_token` | 重定向 |
| 操作记录 | GET | `/audit` | 无 | HTML |
| 图片管理页 | GET | `/images` | `q,page,per_page`（可选） | HTML |
| 上传图片 | POST | `/images/upload` | `image,watermark_text,csrf_token` | 重定向 |
| 图片详情 | GET | `/images/<id>` | `id` | HTML |
| 预览水印图 | GET | `/images/<id>/preview` | `id` | 图片内容 |
| 查看原图 | GET | `/images/<id>/original` | `id` | 图片内容 |
| 下载水印图 | GET | `/images/<id>/download` | `id` | 文件下载 |
| 删除图片记录 | POST | `/images/<id>/delete` | `csrf_token` | 重定向 |
| 批量操作 | POST | `/images/bulk` | `action,image_ids[],watermark_text,next,csrf_token` | 重定向 |

JSON 接口（用于抓包/测试）：

| 功能 | 方法 | URI | 入参 | 出参 |
|---|---|---|---|---|
| 健康检查 | GET | `/api/health` | 无 | `{ok,time,user}` |
| 用户日志 | GET | `/api/audit` | Cookie Session | `{logs:[...]}` |
| 图片列表 | GET | `/api/images` | Cookie Session + `q/page/per_page`（可选） | `{images:[...],page,per_page}` |

---

## 三、实验详情（对应实验作业二）

### 3.1 攻防实验选择说明

选择内容（1）：SQL 注入 + 命令注入实验。

- 实验入口：`/labs`
- 展示方式：每个实验提供“漏洞版/防御版”对比页面，便于观察差异
- 漏洞代码文件：`websec_app/labs.py`（仅用于课程演示）

> TODO(截图-18)：攻防实验入口页（/labs）

> 注意：漏洞代码仅用于课程演示，请勿用于生产环境或公网部署。

### 3.2 SQL 注入实验（漏洞版 / 防御版）

#### 目标

- 构造 SQL 注入漏洞并复现利用
- 给出防御方案并对比防御前后差异

#### 实验环境与数据

- 页面：`/labs/sql-injection`
- 数据表：`notes`（实验用示例表，内置少量数据）
- 漏洞点：漏洞版把用户输入拼接进 SQL 字符串（`labs.py` 中 insecure 处理）
- 防御点：防御版使用参数化查询（占位符 `?`）

#### 漏洞版复现步骤

1) 登录后打开 `/labs/sql-injection`
2) 在“漏洞版（拼接 SQL）”输入 payload（示例）：
   - `%' OR 1=1 --`
3) 点击“查询”，观察：
   - 页面显示“执行 SQL（展示用）”
   - 结果条数明显增多（可返回更多/全部记录）

> TODO(截图-19)：SQL 注入页面（漏洞版输入 payload）
> TODO(截图-20)：SQL 注入结果（漏洞版：展示拼接 SQL + 返回多条）

#### 防御版对比步骤

1) 在“防御版（参数化查询）”输入同样 payload
2) 点击“查询”，观察：
   - 执行 SQL 结构保持不变（使用占位符）
   - payload 作为普通字符串匹配，不会扩大查询范围

> TODO(截图-21)：SQL 注入结果（防御版：参数化 SQL + 结果不被扩大）

#### 防御方案总结

- 参数化查询（必须）：把“数据”与“SQL 结构”分离
- 输入约束（可选）：长度限制、字符集限制、按业务做格式校验
- 最小权限（理念）：生产环境给 DB 账号授予最小权限（实验 SQLite 略）

### 3.3 命令注入实验（漏洞版 / 防御版）

#### 目标

- 构造命令注入漏洞并复现利用
- 给出防御方案并对比防御前后差异

#### 实验环境

- 页面：`/labs/command-injection`
- 功能：输入 `host`，执行 `ping` 并回显输出

#### 漏洞版复现步骤

1) 打开 `/labs/command-injection`
2) 在“漏洞版（shell=True 拼接命令）”输入（按系统选择）：
   - Windows：`127.0.0.1 & whoami`
   - Linux/macOS：`127.0.0.1; whoami`
3) 点击“执行”，观察：
   - 除 ping 输出外，还可能出现 `whoami` 输出（说明命令被拼接执行）

> TODO(截图-22)：命令注入页面（漏洞版输入 payload）
> TODO(截图-23)：命令注入结果（漏洞版：输出包含额外命令结果）

#### 防御版对比步骤

1) 在“防御版（输入校验 + shell=False）”输入同样 payload
2) 点击“执行”，观察：
   - 校验失败（提示 host 不合法）或无法触发额外命令
   - 输出仅与 ping 相关

> TODO(截图-24)：命令注入结果（防御版：校验失败或输出正常）

#### 防御方案总结

- 禁用 `shell=True`：以列表参数执行外部命令（`shell=False`）
- 白名单校验：只允许域名或 IP
- 运行控制：超时、输出长度限制、最小权限运行服务

### 3.4 Web 安全测试实验

#### 目标

1) 抓取并分析 request/response，对比 HTTP vs HTTPS
2) 使用渗透测试工具/模糊测试工具对平台进行测试，并说明结果

#### 3.4.1 DevTools 抓包（HTTP vs HTTPS）

步骤：

1) 打开浏览器开发者工具（Network）
2) 分别访问：
   - HTTP：`http://127.0.0.1:5000/api/health`
   - HTTPS：`https://127.0.0.1:5443/api/health`
3) 对比记录：
   - 请求行、状态码、请求/响应头
   - 登录后 Cookie（Session）变化

> TODO(截图-25)：DevTools - HTTP 请求详情（/api/health）
> TODO(截图-26)：DevTools - HTTPS 请求详情（/api/health）

#### 3.4.2 Wireshark 抓包对比（明文 vs TLS）

建议流程：

1) HTTP 场景抓包
   - 过滤条件：`http`
   - 预期：可直接看到明文请求行/Header/Body
2) HTTPS 场景抓包
   - 过滤条件：`tls`（或 `tcp.port==5443`）
   - 预期：能看到 TLS 握手与加密 Application Data，业务明文不可直接读取

> TODO(截图-27)：Wireshark - HTTP 明文请求（过滤 `http`）
> TODO(截图-28)：Wireshark - HTTPS/TLS 流量（过滤 `tls` 或端口）

#### 3.4.3 BurpSuite（可选）抓包/重放与说明

可选说明（写入你实际做的内容）：

- 将浏览器代理指向 Burp，访问 HTTP 地址可直接拦截明文
- HTTPS 若要解密查看明文，需要在浏览器安装 Burp CA 证书（实验环境自行决定）
- 对登录接口、图片上传接口进行重放，观察 CSRF 与 Cookie 的作用

> TODO(截图-29)：Burp - 拦截 HTTP 请求（明文）
> TODO(截图-30)：Burp - 重放/修改请求并观察响应（建议用 /api/health 或 /login）

#### 3.4.4 漏洞扫描（Nessus / ZAP / 其他）与结果说明（可选）

说明：是否使用 Nessus/Metasploit/ZAP 取决于本地环境。此处写入你实际使用的工具与结果。

可写入的典型结论（示例）：

- HTTPS 使用自签名证书（实验用途，可作为发现项说明）
- `/labs` 为故意漏洞模块，若公网部署风险极高（需要访问控制/下线）

> TODO(截图-31)：扫描工具结果概览（若实际使用）

#### 3.4.5 模糊测试（Fuzz）与结果说明

工具：`tools/fuzz_login.py`（对登录接口进行随机输入请求）

步骤：

1) 启动 HTTP 服务：`python tools/bootstrap.py run-http`
2) 运行 fuzz：`python tools/fuzz_login.py`
3) 观察输出：
   - 预期：服务稳定返回 302/4xx 等，不崩溃，不出现大量 500

结论（可按你的实际运行结果填写）：

- 登录接口对异常输入能稳定处理
- 失败登录会写入审计日志（便于溯源）

> TODO(截图-32)：fuzz 运行终端输出（包含状态码统计）
> TODO(截图-33)：审计日志中出现 fuzz/失败登录记录（可选）

---

## 四、结尾

### 4.1 小组分工与贡献（模板）

（按实际填写）

- 成员 A（姓名/学号）：应用设计、后端开发、数据库与会话模块
- 成员 B（姓名/学号）：前端页面与美化、图片管理页交互、文档撰写
- 成员 C（姓名/学号）：SQL/命令注入实验设计与验证、对比分析
- 成员 D（姓名/学号）：抓包分析（DevTools/Wireshark/Burp）、扫描与 fuzz 测试

### 4.2 源码链接

- GitHub/Gitee：__________（将本仓库推送后填写链接）

> TODO(截图-34)：代码仓库首页（README + 提交记录，可选）
