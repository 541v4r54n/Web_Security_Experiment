# 实验作业二：Web攻防与安全测试实验报告

## 一、封面

- 报告名称：Web安全实验（作业一 & 作业二）综合报告
- 课程/班级：__________
- 指导老师：__________
- 小组成员：__________（姓名/学号/分工见“结尾”）
- 完成日期：2025-12-15

## 二、产品描述（对应实验作业一）

### 2.1 产品简介

产品名称：WebSec Lab（图片水印管理系统）

产品定位：用于 Web 安全课程实验的本地可部署 Web 应用平台，提供用户管理、会话管理、操作审计以及核心业务功能，并为作业二攻防实验提供实验入口。

### 2.2 开发技术

- 后端：Python 3.13 + Flask 3
- 前端：Bootstrap 5（CDN）+ Vue3（CDN）
- 数据库：SQLite（`var/app.db`）
- 会话管理：基于 Cookie Session（登录后写入 `session["user_id"]`，并设置会话超时）
- Web 协议：
  - HTTP：Waitress 运行
  - HTTPS：自签名证书（`var/certs/localhost.crt|localhost.key`）+ Flask `ssl_context`（仅实验用途）
- 项目管理：mise（固定 Python 版本与任务编排）

### 2.3 部署方法（本地）

在仓库根目录执行：

- `mise trust`
- `mise run setup`
- `mise run run-http`（HTTP：`http://127.0.0.1:5000`）
- `mise run run-https`（HTTPS：`https://127.0.0.1:5443`）

### 2.4 业务功能与使用方法（图解位置）

1) 用户注册/登录
- 注册：访问 `/register`，填写用户名与密码
- 登录：访问 `/login`，输入用户名与密码

2) 图片水印管理
- 入口：`/images`
- 操作：选择图片文件 + 填写水印文字 → 上传 → 自动生成水印图
- 查看/下载：点击列表进入 `/images/<id>` → 下载水印图

3) 操作记录
- 入口：`/audit`
- 内容：登录、登出、资料修改、上传、实验访问等记录（含 IP、UA、时间）

图解/截图建议：
- 图1：注册页面
- 图2：登录页面
- 图3：上传图片并生成水印
- 图4：图片列表与下载
- 图5：操作记录页面

### 2.5 接口设计

页面接口（节选）：

| 功能 | 方法 | URI | 入参 | 出参 |
|---|---|---|---|---|
| 主页 | GET | `/` | 无 | HTML |
| 注册 | GET/POST | `/register` | username,password,csrf_token | 重定向/HTML |
| 登录 | GET/POST | `/login` | username,password,next,csrf_token | 重定向/HTML |
| 登出 | POST | `/logout` | csrf_token | 重定向 |
| 个人资料 | GET/POST | `/profile` | display_name,description,csrf_token | 重定向/HTML |
| 删除账号 | POST | `/account/delete` | confirm,csrf_token | 重定向 |
| 操作记录 | GET | `/audit` | 无 | HTML |
| 图片列表 | GET | `/images` | 无 | HTML |
| 上传图片 | POST | `/images/upload` | image,watermark_text,csrf_token | 重定向 |
| 图片详情 | GET | `/images/<id>` | id | HTML |
| 下载水印图 | GET | `/images/<id>/download` | id | 文件下载 |

JSON 接口（用于抓包/测试）：

| 功能 | 方法 | URI | 入参 | 出参 |
|---|---|---|---|---|
| 健康检查 | GET | `/api/health` | 无 | `{ok,time,user}` |
| 用户日志 | GET | `/api/audit` | Cookie Session | `{logs:[...]}` |
| 图片列表 | GET | `/api/images` | Cookie Session | `{images:[...]}` |

## 三、实验详情（对应实验作业二）

### 3.1 Web攻防实验选择

选择内容（1）：SQL 注入和命令注入实验（均在 `/labs` 模块提供“漏洞版/防御版”对比）。

> 注意：漏洞代码仅用于课程演示，请勿用于生产环境或公网部署。

---

### 3.2 SQL 注入实验

#### 目标

- 构造一个 SQL 注入漏洞
- 展示漏洞利用效果
- 给出防御方案并对比防御前/后的差异

#### 实验场景

- 实验入口：`/labs/sql-injection`
- 数据表：`notes`（用于实验的示例数据）

#### 步骤（漏洞版）

1) 登录后打开 `/labs/sql-injection`
2) 在“漏洞版（拼接 SQL）”中输入 payload：
   - `%' OR 1=1 --`
3) 提交后观察结果：
   - 预期：绕过原本的关键词过滤，返回更多/全部记录
4) 观察页面展示的“执行 SQL”：
   - 预期：能看到用户输入被拼接进 SQL 字符串

#### 步骤（防御版）

1) 在“防御版（参数化查询）”中输入同样 payload
2) 提交后观察结果：
   - 预期：payload 被当作普通字符串处理，无法改变 SQL 结构，返回结果不会被“注入扩大”

#### 防御要点

- 使用参数化查询（占位符 `?` + 参数传递）
- 对输入进行长度限制与必要的格式校验（可选）
- 最小权限原则（数据库账号权限控制，实验中 SQLite 省略）

#### 防御前后对比（结论）

- 漏洞版：输入可影响 SQL 语义 → 可能导致越权查询/数据泄露
- 防御版：输入仅作为参数值 → 无法改变 SQL 语义结构

---

### 3.3 命令注入实验

#### 目标

- 构造一个命令注入漏洞
- 展示漏洞利用效果
- 给出防御方案并对比防御前/后的差异

#### 实验场景

- 实验入口：`/labs/command-injection`
- 功能：输入 host，执行 `ping` 并展示输出

#### 步骤（漏洞版）

1) 登录后打开 `/labs/command-injection`
2) 在“漏洞版（shell=True 拼接命令）”输入（Windows 示例）：
   - `127.0.0.1 & whoami`
3) 提交后观察输出：
   - 预期：除 ping 输出外，还会额外出现 `whoami` 的结果

#### 步骤（防御版）

1) 在“防御版（输入校验 + shell=False）”输入同样 payload
2) 提交后观察现象：
   - 预期：输入校验失败或无法触发额外命令，输出只与 ping 相关

#### 防御要点

- 禁止 `shell=True`，使用参数列表方式执行命令（`shell=False`）
- 对 host 做白名单校验（仅允许域名/IP）
- 设置超时与输出长度限制，防止长时间阻塞与日志膨胀

#### 防御前后对比（结论）

- 漏洞版：用户输入可拼接到 shell 命令 → 存在任意命令执行风险
- 防御版：输入校验 + 非 shell 执行 → 大幅降低注入风险

---

### 3.4 Web 安全测试实验

#### 目标

1) 抓取并分析接口 request/response，并对比 http vs https
2) 使用渗透测试工具与模糊测试工具对平台进行测试，并说明结果

#### 3.4.1 浏览器抓包与分析（DevTools）

1) 打开浏览器开发者工具（Network）
2) 访问：
   - HTTP：`http://127.0.0.1:5000/api/health`
   - HTTPS：`https://127.0.0.1:5443/api/health`
3) 观察并记录：
   - 请求方法、URL、状态码
   - Request Headers / Response Headers
   - Cookie（登录后会出现 session cookie）

截图建议：
- 图6：HTTP 的 request/response 详情
- 图7：HTTPS 的 request/response 详情

#### 3.4.2 BurpSuite / Wireshark 等抓包对比（说明）

建议流程：
1) HTTP 场景下抓包
   - 预期：能在报文中直接看到明文的 HTTP 请求行、Header 与 Body
2) HTTPS 场景下抓包
   - 预期：网络层可见 TLS 握手与加密数据，业务明文不可直接读取

截图建议：
- 图8：Wireshark 过滤 `http` 的明文请求
- 图9：Wireshark 过滤 `tls` 的握手与加密流量

#### 3.4.3 渗透测试工具（Nessus/Metasploit 等）与结果说明（简版）

说明：实验环境以本地为主，扫描/测试结果会因工具版本、规则库、配置不同而变化。以下为可复现的建议步骤与示例结论。

1) Nessus（示例）
- 目标：`127.0.0.1:5000`（HTTP）与 `127.0.0.1:5443`（HTTPS）
- 可能发现项（示例）：
  - HTTPS 使用自签名证书（实验用途）
  - 缺少部分安全响应头（例如 CSP、HSTS 等，实验可不强制）

2) Metasploit（示例）
- 使用 HTTP 扫描类模块对目标进行信息收集
- 结果说明（示例）：
  - 识别到服务响应、路径可达
  - 对 `/labs` 类路径在公网部署时存在高风险（本实验为故意漏洞模块）

截图建议：
- 图10：Nessus 扫描概览
- 图11：Metasploit 扫描输出

#### 3.4.4 模糊测试（Fuzz）与结果说明

工具选择：
- 自编写简易 fuzz：`tools/fuzz_login.py`（对登录接口做随机用户名/密码请求）
- 或使用 ffuf/OWASP ZAP 等（可选）

步骤（自编写 fuzz）：
1) 启动 HTTP 服务 `mise run run-http`
2) 执行：`.\\.venv\\Scripts\\python tools\\fuzz_login.py`
3) 观察输出：
   - 预期：接口稳定返回 302 重定向或 200/4xx，不崩溃、不出现 500

结果说明（示例）：
- 登录接口在错误输入下返回提示并写入审计日志
- 未出现服务崩溃或长时间无响应

## 四、结尾

### 4.1 小组分工与贡献（示例模板）

（请按实际填写）

- 成员A：应用设计、后端开发、数据库与会话模块
- 成员B：前端页面、美化、接口整理、文档撰写
- 成员C：Web攻防实验设计与验证（SQL/命令注入）
- 成员D：抓包分析、安全测试（DevTools/Burp/Wireshark/Nessus/Metasploit/Fuzz）

### 4.2 源码链接

- GitHub/Gitee：__________（请将本仓库推送后填写链接）

