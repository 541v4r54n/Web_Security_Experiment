{% extends "base.html" %}
{% block title %}图片水印 - Web安全实验平台{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">上传并生成水印</h5>
        <form method="post" action="{{ url_for('images.upload') }}" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div class="mb-3">
            <label class="form-label">图片文件</label>
            <input class="form-control" type="file" name="image" accept=".png,.jpg,.jpeg,.bmp,.webp" required />
          </div>
          <div class="mb-3">
            <label class="form-label">水印文字</label>
            <input class="form-control" name="watermark_text" placeholder="例如：仅供学习使用" />
          </div>
          <button class="btn btn-success w-100">上传</button>
        </form>
      </div>
    </div>
    <div class="alert alert-info mt-3 small">
      前端展示使用 Vue3（CDN），便于作业一“JS 框架”要求与抓包分析。
    </div>
  </div>

  <div class="col-lg-8" id="image-app">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">我的图片</h5>
      <button class="btn btn-sm btn-outline-primary" type="button" @click="refresh">刷新</button>
    </div>
      <div v-if="loading" class="text-muted">加载中...</div>
      <div v-else>
        <div v-if="images.length === 0" class="text-muted">暂无记录</div>
        <div class="list-group shadow-sm" v-else>
          <a class="list-group-item list-group-item-action" v-for="img in images" :key="img.id" :href="detailUrl(img.id)">
            <div class="d-flex w-100 justify-content-between">
              <div>
                <div class="fw-semibold">{{ img.original_name }}</div>
                <div class="small text-muted">水印：{{ img.watermark_text || '-' }}</div>
              </div>
              <small class="text-muted">{{ img.created_at }}</small>
            </div>
          </a>
        </div>
      </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
  const { createApp } = Vue;
  createApp({
    data() {
      return { images: [], loading: true };
    },
    mounted() { this.refresh(); },
    methods: {
      detailUrl(id) { return `/images/${id}`; },
      async refresh() {
        this.loading = true;
        const resp = await fetch('/api/images', { headers: { 'Accept': 'application/json' }});
        const data = await resp.json();
        this.images = data.images || [];
        this.loading = false;
      }
    }
  }).mount('#image-app');
</script>
{% endblock %}
